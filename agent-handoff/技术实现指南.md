# 🔧 技术实现指南

## 📋 核心技术栈
- **BlockNote**: 0.39.1 - 基础编辑器框架
- **React**: 18+ - UI框架  
- **KaTeX**: 0.16.22 - 数学公式渲染
- **TypeScript**: 5.4.5 - 类型安全

## 🏗️ 架构设计

### 组件结构
```
TrueInlineMathV2Editor/
├── InlineMathComponent     # 行内公式渲染组件
├── inlineMathSpec         # BlockNote行内内容规范
├── schema                 # 扩展的编辑器模式
└── 智能交互逻辑            # 快捷键和转换逻辑
```

### 关键API实现
```typescript
// 1. 行内公式规范定义
const inlineMathSpec = createReactInlineContentSpec(
  {
    type: "inlineMath",
    propSchema: { latex: { default: "" } },
    content: "none",
  },
  { render: InlineMathComponent }
);

// 2. Schema扩展
const schema = BlockNoteSchema.create({
  blockSpecs: { ...defaultBlockSpecs, math: mathBlockSpec() },
  inlineContentSpecs: { ...defaultInlineContentSpecs, inlineMath: inlineMathSpec }
});

// 3. 智能快捷键处理
const handleKeyDown = useCallback((event: KeyboardEvent) => {
  if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key.toLowerCase() === 'e') {
    event.preventDefault();
    const selectedText = getSelection()?.toString().trim();
    
    if (selectedText) {
      // 转换选中文本为行内公式
      convertTextToInlineMath(selectedText);
    } else {
      // 打开输入对话框
      openMathInputDialog();
    }
  }
}, [editor]);
```

## 🎯 实现要点

### 1. 行内公式渲染
- 使用 `createReactInlineContentSpec` 创建行内内容规范
- 实现点击编辑、键盘导航、自动保存
- KaTeX渲染，支持错误处理

### 2. 智能文本转换
- 检测文本选择状态
- 调用 `insertInlineContent` API 插入行内公式
- 提供回退机制确保功能稳定

### 3. SSR兼容性
```typescript
// 关键：所有window对象使用都需要检查
const selection = typeof window !== 'undefined' ? window.getSelection() : null;
```

### 4. 样式集成
```typescript
import "@blocknote/core/style.css";
import "@blocknote/mantine/style.css";  // 注意：不是 /dist/style.css
import "katex/dist/katex.min.css";
```

## 🚨 关键问题解决

### 类型安全
- 最小化 `as any` 使用，仅在必要的类型断言处使用
- 保持业务逻辑的完整类型检查

### 缓存问题  
- Next.js缓存可能导致修改不生效
- 必要时清除 `.next` 目录重新编译

### API理解
- BlockNote行内内容API与块内容API完全不同
- 需要深入理解 `createReactInlineContentSpec` 的正确用法

## 📦 集成方式

### 完整组件使用
```tsx
import { TrueInlineMathV2Editor } from './components/TrueInlineMathV2Editor';

function App() {
  return <TrueInlineMathV2Editor onChange={handleChange} />;
}
```

### 手动集成
```tsx
import { BlockNoteSchema, defaultBlockSpecs, defaultInlineContentSpecs } from "@blocknote/core";
import { useCreateBlockNote } from "./hooks/useCreateBlockNote";

// 创建自定义schema
const schema = BlockNoteSchema.create({
  blockSpecs: { ...defaultBlockSpecs, math: mathBlockSpec() },
  inlineContentSpecs: { ...defaultInlineContentSpecs, inlineMath: inlineMathSpec }
});

// 使用自定义编辑器
const editor = useCreateBlockNote({ schema });
```

---

**技术总结**: 成功突破了BlockNote行内内容扩展的技术难点，建立了完整可复用的数学公式扩展架构。