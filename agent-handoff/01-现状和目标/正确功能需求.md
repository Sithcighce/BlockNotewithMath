# 🎯 正确的功能需求规范 - 基于 Notion 交互逻辑

## 📋 需求澄清和修正

### 用户反馈的关键修正
> "不是便捷插入某个公式，是便捷把文本变成公式或者唤起公式块！而且需要区分行内公式和公式块。"

这个反馈完全改变了我们对功能需求的理解。

## 🔍 基于 Notion 的正确交互逻辑

### 行内公式 (Inline Math)
**Notion 的实现方式:**
```
创建方法：
1. $$formula$$ → 自动转换为行内公式
2. 选中文本 + Ctrl+Shift+E → 将文本转换为行内公式  
3. Ctrl+Shift+E → 打开行内公式输入框

显示效果：
- 在文本行内显示，与文字混排
- 较小字体，适合简单表达式
- 例如：The formula $E = mc^2$ is famous.
```

### 公式块 (Block Math)  
**Notion 的实现方式:**
```
创建方法：
1. /math → 创建独立公式块
2. 点击 + 按钮选择 Block equation

显示效果：
- 独立块，居中显示
- 较大字体，适合复杂公式
- 支持多行复杂数学表达式
```

## ✅ 我们需要实现的具体功能

### 1. 智能快捷键系统
```typescript
// Ctrl+Shift+E 的正确行为逻辑
function handleCtrlShiftE() {
  const selectedText = getSelection();
  
  if (selectedText && selectedText.length > 0) {
    // 场景1: 有选中文本 → 转换为行内公式
    convertTextToInlineMath(selectedText);
  } else {
    // 场景2: 无选中文本 → 打开行内公式输入框
    openInlineMathInput();
  }
}
```

### 2. 自动检测转换
```typescript
// $$formula$$ 的自动检测和转换
function detectDoubleDollar(text) {
  const pattern = /\$\$([^$]+)\$\$/g;
  return text.replace(pattern, (match, formula) => {
    return createInlineMath(formula);
  });
}
```

### 3. Slash命令集成
```typescript
// 原生slash菜单集成
const slashMenuItems = [
  {
    name: "Math Block",
    execute: () => createMathBlock(),
    aliases: ["math", "equation", "formula", "eq", "gs"]
  }
];
```

## 🛠️ 技术实现要求

### 行内公式技术规范
```typescript
// BlockNote 行内内容规范
const inlineMathSpec = createReactInlineContentSpec({
  type: "inlineMath",
  propSchema: {
    latex: { default: "" }
  },
  content: "none"
}, {
  render: ({ inlineContent }) => (
    <InlineMathComponent latex={inlineContent.props.latex} />
  )
});
```

### 文本转换技术要求
```typescript
// 选中文本替换为行内公式
function convertSelectedTextToMath(editor, selectedText) {
  // 1. 获取当前选择范围
  const selection = editor.getTextSelection();
  
  // 2. 创建行内公式内容  
  const inlineMath = {
    type: "inlineMath",
    props: { latex: selectedText }  
  };
  
  // 3. 替换选中内容
  editor.replaceInlineContent(selection, [inlineMath]);
}
```

### 样式要求
```css
/* 行内公式样式 */
.inline-math {
  display: inline;
  font-size: 1em;
  vertical-align: baseline;
  margin: 0 2px;
  padding: 1px 3px;
  background-color: #f8fafc;
  border-radius: 3px;
}

/* 公式块样式 */  
.math-block {
  display: block;
  text-align: center;
  font-size: 1.2em;
  margin: 16px 0;
  padding: 12px;
  background-color: #fafafa;
  border-radius: 6px;
}
```

## 📝 用户交互流程设计

### 场景1: 文本转公式
```
用户操作：
1. 在编辑器中输入 "E = mc^2"
2. 选中这段文本  
3. 按 Ctrl+Shift+E

预期结果：
- 选中的文本被替换为渲染的行内公式
- 公式可点击编辑
- 与周围文本无缝混排
```

### 场景2: 快速插入
```
用户操作：
1. 光标定位在文本中
2. 按 Ctrl+Shift+E (无选中文本)

预期结果：  
- 弹出行内公式输入框
- 输入LaTeX公式
- 按Enter插入到光标位置
```

### 场景3: 自动检测
```
用户操作：
1. 在编辑器中输入 "$$E = mc^2$$"
2. 继续输入其他内容

预期结果：
- $$E = mc^2$$ 自动转换为行内公式
- 后续文本正常显示
- 转换后的公式可编辑
```

### 场景4: 公式块创建
```
用户操作：
1. 输入 "/math" 
2. 从slash菜单选择

预期结果：
- 创建独立的数学公式块
- 自动进入编辑模式
- 支持多行复杂公式
```

## 🎯 验收标准

### 功能完整性
- [ ] `Ctrl+Shift+E` 智能行为正确
- [ ] `$$formula$$` 自动检测转换  
- [ ] `/math` slash命令工作
- [ ] 行内公式与文本混排
- [ ] 公式块独立显示
- [ ] 点击编辑功能正常

### 用户体验
- [ ] 转换过程流畅无卡顿
- [ ] 错误提示友好清晰
- [ ] 编辑操作符合直觉
- [ ] 键盘导航支持完整
- [ ] 样式与BlockNote一致

### 技术质量  
- [ ] TypeScript类型完整
- [ ] 错误处理充分
- [ ] 性能表现良好
- [ ] 代码结构清晰
- [ ] 测试覆盖充分

## 🚨 常见错误避免

### ❌ 错误理解
- 把快捷键当作"插入特定公式"的工具
- 只实现公式块，忽略行内公式
- 用工具栏按钮代替真正的快捷键逻辑

### ✅ 正确理解  
- 快捷键是"转换工具"，根据上下文智能反应
- 需要同时支持行内公式和公式块两种模式
- 真正集成到BlockNote的交互系统中

---

**这份文档是我们实现的北极星，所有开发都应该以此为准！**