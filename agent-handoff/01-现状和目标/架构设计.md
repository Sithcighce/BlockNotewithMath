# ğŸ—ï¸ æ¶æ„è®¾è®¡è¯¦è§£

## ğŸ“ æ•´ä½“æ¶æ„

### è®¾è®¡ç†å¿µ
**ã€Œä¸€è¡Œé›†æˆï¼Œæ— ç¼ä½“éªŒã€** - è®©å¼€å‘è€…ç”¨æœ€å°‘çš„ä»£ç è·å¾—æœ€å®Œæ•´çš„æ•°å­¦ç¼–è¾‘åŠŸèƒ½ã€‚

### æ¶æ„å±‚æ¬¡
```
ç”¨æˆ·åº”ç”¨å±‚
    â†“ ä¸€è¡Œä»£ç é›†æˆ
æ ¸å¿ƒAPIå±‚ (createMathExtension)
    â†“ ç»„ä»¶å’Œé…ç½®
ç»„ä»¶å®ç°å±‚ (MathBlock, MathInputDialog)
    â†“ æ¸²æŸ“å¼•æ“
åŸºç¡€è®¾æ–½å±‚ (KaTeX, BlockNote)
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶æ¶æ„

### 1. ä¸€è¡Œé›†æˆ API
```tsx
// src/index.ts - ç»Ÿä¸€å…¥å£
export function createMathExtension() {
  return {
    blockSpecs: {
      math: createReactBlockSpec(mathBlockConfig, {
        render: (props) => React.createElement(MathBlock, props)
      })
    }
  };
}

// ç®€åŒ–å¯¼å‡º
export const mathBlocks = {
  math: () => createMathExtension().blockSpecs.math
};
```

### 2. æ•°å­¦å—ç»„ä»¶ (MathBlock.tsx)
```tsx
// æ ¸å¿ƒçŠ¶æ€ç®¡ç†
const [isEditing, setIsEditing] = useState(false);
const [formula, setFormula] = useState(block.props.formula);
const [error, setError] = useState<string | null>(null);

// æ¸²æŸ“é€»è¾‘
if (isEditing) {
  return <TextareaAutosize />; // ç¼–è¾‘æ¨¡å¼
} else {
  return <KaTeXRenderer />; // é¢„è§ˆæ¨¡å¼
}
```

### 3. BlockNote é›†æˆè§„èŒƒ
```tsx
// MathBlockSpec.ts
export const mathBlockConfig = {
  type: "math" as const,
  propSchema: {
    formula: {
      default: "E = mc^2"
    }
  },
  content: "none"
};
```

## ğŸ¯ API è®¾è®¡åŸåˆ™

### 1. æœ€å°åŒ–é›†æˆæˆæœ¬
```tsx
// ç›®æ ‡ï¼šåªéœ€è¦è¿™ä¸€è¡Œ
const mathExt = createMathExtension();

// è€Œä¸æ˜¯å¤æ‚çš„é…ç½®
const mathConfig = {
  blocks: [...],
  menu: [...],
  shortcuts: [...],
  // å¤ªå¤æ‚äº†ï¼
};
```

### 2. æ¸è¿›å¼åŠŸèƒ½å¢å¼º
```tsx
// åŸºç¡€ä½¿ç”¨
const mathExt = createMathExtension();

// é«˜çº§ä½¿ç”¨ï¼ˆæœªæ¥ï¼‰
const mathExt = createMathExtension({
  slashCommands: true,
  keyboardShortcuts: true,
  toolbar: true,
  inlineMath: true
});
```

### 3. ç±»å‹å®‰å…¨ä¿è¯
```tsx
// å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
interface MathBlockProps {
  block: Block<'math', { formula: string }>;
  editor: BlockNoteEditor;
}

interface MathExtensionOptions {
  slashCommands?: boolean;
  keyboardShortcuts?: boolean;
  // ...
}
```

## ğŸ”„ æ•°æ®æµæ¶æ„

### 1. ç¼–è¾‘æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»æ•°å­¦å—
    â†“
åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼ (setIsEditing(true))
    â†“
æ˜¾ç¤ºæ–‡æœ¬è¾“å…¥æ¡†
    â†“
ç”¨æˆ·è¾“å…¥ LaTeX
    â†“
å®æ—¶éªŒè¯è¯­æ³• (KaTeX.renderToString)
    â†“
ä¿å­˜åˆ° BlockNote (updateBlock)
    â†“
åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
    â†“
æ¸²æŸ“æ•°å­¦å…¬å¼
```

### 2. é”™è¯¯å¤„ç†æµç¨‹
```
KaTeX æ¸²æŸ“å¤±è´¥
    â†“
æ•è· ParseError
    â†“
è®¾ç½®é”™è¯¯çŠ¶æ€ (setError)
    â†“
æ˜¾ç¤ºå‹å¥½é”™è¯¯æ¶ˆæ¯
    â†“
ä¿æŒç¼–è¾‘æ¨¡å¼è®©ç”¨æˆ·ä¿®æ­£
```

### 3. SSR å…¼å®¹æ€§å¤„ç†
```
æœåŠ¡ç«¯æ¸²æŸ“
    â†“
è·³è¿‡ window ç›¸å…³æ“ä½œ
    â†“
ä»…æ¸²æŸ“é™æ€å†…å®¹
    â†“
å®¢æˆ·ç«¯æ¿€æ´»
    â†“
æ¢å¤å®Œæ•´äº¤äº’åŠŸèƒ½
```

## ğŸ¨ æ ·å¼æ¶æ„

### 1. CSS å˜é‡ç³»ç»Ÿ
```css
.math-block {
  --math-bg: #f8f9fa;
  --math-border: #dee2e6;
  --math-focus: #0d6efd;
  --math-error: #dc3545;
}

[data-theme='dark'] .math-block {
  --math-bg: #2d3748;
  --math-border: #4a5568;
  --math-focus: #63b3ed;
  --math-error: #fc8181;
}
```

### 2. å“åº”å¼è®¾è®¡
```css
.math-block {
  min-height: 60px;
  padding: 12px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.math-block:hover {
  background-color: var(--math-bg);
  border-color: var(--math-focus);
}
```

## ğŸ”Œ æ‰©å±•æ€§è®¾è®¡

### 1. æ’ä»¶æ¶æ„ï¼ˆæœªæ¥ï¼‰
```tsx
// æœªæ¥å¯ä»¥æ”¯æŒæ’ä»¶æ‰©å±•
const mathExt = createMathExtension({
  plugins: [
    slashCommandsPlugin(),
    keyboardShortcutsPlugin(),
    toolbarPlugin(),
    inlineMathPlugin()
  ]
});
```

### 2. ä¸»é¢˜ç³»ç»Ÿ
```tsx
// ä¸»é¢˜å®šåˆ¶æ”¯æŒ
const mathExt = createMathExtension({
  theme: {
    colors: {
      background: '#f5f5f5',
      border: '#d1d5db',
      focus: '#3b82f6'
    },
    fonts: {
      mono: 'JetBrains Mono, monospace'
    }
  }
});
```

### 3. æ¸²æŸ“å™¨å®šåˆ¶
```tsx
// è‡ªå®šä¹‰æ¸²æŸ“å™¨æ”¯æŒ
const mathExt = createMathExtension({
  renderer: {
    engine: 'katex', // æˆ– 'mathjax'
    options: {
      displayMode: false,
      throwOnError: false
    }
  }
});
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ¶æ„

### 1. æ‡’åŠ è½½ç­–ç•¥
```tsx
// KaTeX æŒ‰éœ€åŠ è½½
const KaTeX = lazy(() => import('katex'));

// ç»„ä»¶æ‡’åŠ è½½
const MathInputDialog = lazy(() => import('./MathInputDialog'));
```

### 2. æ¸²æŸ“ä¼˜åŒ–
```tsx
// é˜²æŠ–æ¸²æŸ“
const debouncedRender = useMemo(
  () => debounce((formula: string) => {
    renderMath(formula);
  }, 300),
  []
);

// ç¼“å­˜æ¸²æŸ“ç»“æœ
const renderedMath = useMemo(
  () => renderKaTeX(formula),
  [formula]
);
```

### 3. é”™è¯¯è¾¹ç•Œ
```tsx
// ç»„ä»¶çº§é”™è¯¯è¾¹ç•Œ
class MathBlockErrorBoundary extends Component {
  componentDidCatch(error: Error) {
    console.error('Math block error:', error);
    // é™çº§æ¸²æŸ“
    return <div>æ•°å­¦å…¬å¼æ¸²æŸ“å¤±è´¥</div>;
  }
}
```

## ğŸ” å®‰å…¨æ€§è®¾è®¡

### 1. è¾“å…¥éªŒè¯
```tsx
// LaTeX è¾“å…¥éªŒè¯
function validateLatex(formula: string): boolean {
  // é˜²æ­¢æ¶æ„ä»£ç æ³¨å…¥
  const dangerousPatterns = [/\\input/, /\\include/, /\\write/];
  return !dangerousPatterns.some(pattern => pattern.test(formula));
}
```

### 2. æ¸²æŸ“å®‰å…¨
```tsx
// å®‰å…¨çš„ HTML æ¸²æŸ“
function renderSafeHTML(html: string) {
  return {
    __html: DOMPurify.sanitize(html)
  };
}
```

## ğŸ§ª æµ‹è¯•æ¶æ„

### 1. å•å…ƒæµ‹è¯•
```tsx
// ç»„ä»¶æµ‹è¯•
describe('MathBlock', () => {
  it('renders formula correctly', () => {
    render(<MathBlock formula="E = mc^2" />);
    expect(screen.getByText(/E = mcÂ²/)).toBeInTheDocument();
  });
});
```

### 2. é›†æˆæµ‹è¯•
```tsx
// BlockNote é›†æˆæµ‹è¯•
describe('BlockNote Integration', () => {
  it('inserts math block correctly', () => {
    const editor = createTestEditor();
    insertMathBlock(editor, 'x^2 + y^2 = r^2');
    expect(editor.document).toContainBlock('math');
  });
});
```

### 3. E2E æµ‹è¯•
```tsx
// ç«¯åˆ°ç«¯æµ‹è¯•
test('complete math editing workflow', async ({ page }) => {
  await page.goto('/integrated');
  await page.click('[data-testid="math-block"]');
  await page.fill('textarea', 'x^2 = 4');
  await page.keyboard.press('Escape');
  await expect(page.locator('.katex')).toBeVisible();
});
```

---

## ğŸ“‹ æ¶æ„æ€»ç»“

### è®¾è®¡ä¼˜åŠ¿
âœ… **ç®€å•é›†æˆ** - ä¸€è¡Œä»£ç å®Œæˆé›†æˆ  
âœ… **ç±»å‹å®‰å…¨** - å®Œæ•´ TypeScript æ”¯æŒ  
âœ… **æ€§èƒ½ä¼˜åŒ–** - æ‡’åŠ è½½å’Œç¼“å­˜æœºåˆ¶  
âœ… **æ‰©å±•æ€§å¼º** - æ¨¡å—åŒ–æ’ä»¶æ¶æ„  
âœ… **ç”¨æˆ·å‹å¥½** - ç›´è§‚çš„äº¤äº’è®¾è®¡  
âœ… **å¼€å‘å‹å¥½** - æ¸…æ™°çš„ API å’Œæ–‡æ¡£  

### æŠ€æœ¯é€‰æ‹©
âœ… **ç¨³å®šä¾èµ–** - ä½¿ç”¨æˆç†Ÿç¨³å®šçš„æŠ€æœ¯æ ˆ  
âœ… **æ ‡å‡†å…¼å®¹** - éµå¾ª React/TypeScript æœ€ä½³å®è·µ  
âœ… **æ¡†æ¶æ— å…³** - æ ¸å¿ƒé€»è¾‘ä¸ä¾èµ–ç‰¹å®šæ¡†æ¶  
âœ… **æ¸è¿›å¢å¼º** - æ”¯æŒåŠŸèƒ½é€æ­¥å¯ç”¨  

è¿™ä¸ªæ¶æ„è®¾è®¡ç¡®ä¿äº†é¡¹ç›®çš„**å¯ç”¨æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§**ï¼Œä¸ºç”¨æˆ·æä¾›äº†ç®€å•è€Œå¼ºå¤§çš„æ•°å­¦ç¼–è¾‘èƒ½åŠ›ã€‚