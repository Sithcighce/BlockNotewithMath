# 🏗️ 架构设计详解

## 📐 整体架构

### 设计理念
**「一行集成，无缝体验」** - 让开发者用最少的代码获得最完整的数学编辑功能。

### 架构层次
```
用户应用层
    ↓ 一行代码集成
核心API层 (createMathExtension)
    ↓ 组件和配置
组件实现层 (MathBlock, MathInputDialog)
    ↓ 渲染引擎
基础设施层 (KaTeX, BlockNote)
```

## 🔧 核心组件架构

### 1. 一行集成 API
```tsx
// src/index.ts - 统一入口
export function createMathExtension() {
  return {
    blockSpecs: {
      math: createReactBlockSpec(mathBlockConfig, {
        render: (props) => React.createElement(MathBlock, props)
      })
    }
  };
}

// 简化导出
export const mathBlocks = {
  math: () => createMathExtension().blockSpecs.math
};
```

### 2. 数学块组件 (MathBlock.tsx)
```tsx
// 核心状态管理
const [isEditing, setIsEditing] = useState(false);
const [formula, setFormula] = useState(block.props.formula);
const [error, setError] = useState<string | null>(null);

// 渲染逻辑
if (isEditing) {
  return <TextareaAutosize />; // 编辑模式
} else {
  return <KaTeXRenderer />; // 预览模式
}
```

### 3. BlockNote 集成规范
```tsx
// MathBlockSpec.ts
export const mathBlockConfig = {
  type: "math" as const,
  propSchema: {
    formula: {
      default: "E = mc^2"
    }
  },
  content: "none"
};
```

## 🎯 API 设计原则

### 1. 最小化集成成本
```tsx
// 目标：只需要这一行
const mathExt = createMathExtension();

// 而不是复杂的配置
const mathConfig = {
  blocks: [...],
  menu: [...],
  shortcuts: [...],
  // 太复杂了！
};
```

### 2. 渐进式功能增强
```tsx
// 基础使用
const mathExt = createMathExtension();

// 高级使用（未来）
const mathExt = createMathExtension({
  slashCommands: true,
  keyboardShortcuts: true,
  toolbar: true,
  inlineMath: true
});
```

### 3. 类型安全保证
```tsx
// 完整的 TypeScript 类型定义
interface MathBlockProps {
  block: Block<'math', { formula: string }>;
  editor: BlockNoteEditor;
}

interface MathExtensionOptions {
  slashCommands?: boolean;
  keyboardShortcuts?: boolean;
  // ...
}
```

## 🔄 数据流架构

### 1. 编辑流程
```
用户点击数学块
    ↓
切换到编辑模式 (setIsEditing(true))
    ↓
显示文本输入框
    ↓
用户输入 LaTeX
    ↓
实时验证语法 (KaTeX.renderToString)
    ↓
保存到 BlockNote (updateBlock)
    ↓
切换到预览模式
    ↓
渲染数学公式
```

### 2. 错误处理流程
```
KaTeX 渲染失败
    ↓
捕获 ParseError
    ↓
设置错误状态 (setError)
    ↓
显示友好错误消息
    ↓
保持编辑模式让用户修正
```

### 3. SSR 兼容性处理
```
服务端渲染
    ↓
跳过 window 相关操作
    ↓
仅渲染静态内容
    ↓
客户端激活
    ↓
恢复完整交互功能
```

## 🎨 样式架构

### 1. CSS 变量系统
```css
.math-block {
  --math-bg: #f8f9fa;
  --math-border: #dee2e6;
  --math-focus: #0d6efd;
  --math-error: #dc3545;
}

[data-theme='dark'] .math-block {
  --math-bg: #2d3748;
  --math-border: #4a5568;
  --math-focus: #63b3ed;
  --math-error: #fc8181;
}
```

### 2. 响应式设计
```css
.math-block {
  min-height: 60px;
  padding: 12px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.math-block:hover {
  background-color: var(--math-bg);
  border-color: var(--math-focus);
}
```

## 🔌 扩展性设计

### 1. 插件架构（未来）
```tsx
// 未来可以支持插件扩展
const mathExt = createMathExtension({
  plugins: [
    slashCommandsPlugin(),
    keyboardShortcutsPlugin(),
    toolbarPlugin(),
    inlineMathPlugin()
  ]
});
```

### 2. 主题系统
```tsx
// 主题定制支持
const mathExt = createMathExtension({
  theme: {
    colors: {
      background: '#f5f5f5',
      border: '#d1d5db',
      focus: '#3b82f6'
    },
    fonts: {
      mono: 'JetBrains Mono, monospace'
    }
  }
});
```

### 3. 渲染器定制
```tsx
// 自定义渲染器支持
const mathExt = createMathExtension({
  renderer: {
    engine: 'katex', // 或 'mathjax'
    options: {
      displayMode: false,
      throwOnError: false
    }
  }
});
```

## 📊 性能优化架构

### 1. 懒加载策略
```tsx
// KaTeX 按需加载
const KaTeX = lazy(() => import('katex'));

// 组件懒加载
const MathInputDialog = lazy(() => import('./MathInputDialog'));
```

### 2. 渲染优化
```tsx
// 防抖渲染
const debouncedRender = useMemo(
  () => debounce((formula: string) => {
    renderMath(formula);
  }, 300),
  []
);

// 缓存渲染结果
const renderedMath = useMemo(
  () => renderKaTeX(formula),
  [formula]
);
```

### 3. 错误边界
```tsx
// 组件级错误边界
class MathBlockErrorBoundary extends Component {
  componentDidCatch(error: Error) {
    console.error('Math block error:', error);
    // 降级渲染
    return <div>数学公式渲染失败</div>;
  }
}
```

## 🔐 安全性设计

### 1. 输入验证
```tsx
// LaTeX 输入验证
function validateLatex(formula: string): boolean {
  // 防止恶意代码注入
  const dangerousPatterns = [/\\input/, /\\include/, /\\write/];
  return !dangerousPatterns.some(pattern => pattern.test(formula));
}
```

### 2. 渲染安全
```tsx
// 安全的 HTML 渲染
function renderSafeHTML(html: string) {
  return {
    __html: DOMPurify.sanitize(html)
  };
}
```

## 🧪 测试架构

### 1. 单元测试
```tsx
// 组件测试
describe('MathBlock', () => {
  it('renders formula correctly', () => {
    render(<MathBlock formula="E = mc^2" />);
    expect(screen.getByText(/E = mc²/)).toBeInTheDocument();
  });
});
```

### 2. 集成测试
```tsx
// BlockNote 集成测试
describe('BlockNote Integration', () => {
  it('inserts math block correctly', () => {
    const editor = createTestEditor();
    insertMathBlock(editor, 'x^2 + y^2 = r^2');
    expect(editor.document).toContainBlock('math');
  });
});
```

### 3. E2E 测试
```tsx
// 端到端测试
test('complete math editing workflow', async ({ page }) => {
  await page.goto('/integrated');
  await page.click('[data-testid="math-block"]');
  await page.fill('textarea', 'x^2 = 4');
  await page.keyboard.press('Escape');
  await expect(page.locator('.katex')).toBeVisible();
});
```

---

## 📋 架构总结

### 设计优势
✅ **简单集成** - 一行代码完成集成  
✅ **类型安全** - 完整 TypeScript 支持  
✅ **性能优化** - 懒加载和缓存机制  
✅ **扩展性强** - 模块化插件架构  
✅ **用户友好** - 直观的交互设计  
✅ **开发友好** - 清晰的 API 和文档  

### 技术选择
✅ **稳定依赖** - 使用成熟稳定的技术栈  
✅ **标准兼容** - 遵循 React/TypeScript 最佳实践  
✅ **框架无关** - 核心逻辑不依赖特定框架  
✅ **渐进增强** - 支持功能逐步启用  

这个架构设计确保了项目的**可用性、可维护性和可扩展性**，为用户提供了简单而强大的数学编辑能力。