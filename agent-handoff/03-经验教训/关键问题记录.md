# 🐛 关键问题记录和解决方案

## 🚨 用户反馈的重大问题发现

### 问题1: 快捷键功能的根本性误解 ❌

**错误理解:**
```
Ctrl+Shift+E = 插入 E=mc² 公式
Ctrl+Shift+M = 插入特定数学公式  
Ctrl+Shift+G = 插入求和公式
```

**正确理解:**
```
Ctrl+Shift+E = 智能转换文本为公式，或唤起公式输入
- 有选中文本 → 转换为行内公式
- 无选中文本 → 打开公式输入框
- 空行情况 → 可选择创建公式块
```

**问题根源:** 完全误解了快捷键的用途，应该是**转换工具**而不是**插入工具**

### 问题2: 缺少行内公式 vs 公式块的区分 ⚠️

**缺失功能:**
- 行内公式：`$formula$` 在段落中显示，与文本混排
- 公式块：独立块，居中显示，支持复杂公式
- 两者的不同创建和编辑方式

**影响:** 用户无法像在Notion中一样灵活使用数学公式

### 问题3: BlockNote样式渲染问题 🎨

**发现问题:**
> "blocknote渲染的样式有问题，看起来跟原装不一样"

**根本原因:** 缺少关键样式文件导入
```typescript
// 缺失的样式导入
import "@blocknote/mantine/dist/style.css";
```

## ✅ 已解决的问题

### 1. 样式修复 ✅
**解决方案:**
```typescript
// 添加完整的样式导入
import "@blocknote/core/style.css";
import "@blocknote/mantine/dist/style.css";  // 关键修复
```

**验证方法:** 访问 `/workable` 和 `/correct-shortcuts` 页面确认样式正确

### 2. 快捷键逻辑重构 ✅
**新实现:**
```typescript
const handleKeyDown = useCallback((event: KeyboardEvent) => {
  if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key.toLowerCase() === 'e') {
    event.preventDefault();
    
    const selection = window.getSelection();
    const selectedText = selection?.toString().trim();

    if (selectedText && selectedText.length > 0) {
      // 场景1: 转换选中文本为行内公式
      convertTextToInlineMath(selectedText);
    } else {
      // 场景2: 打开行内公式输入框
      openInlineMathInput();
    }
  }
}, [editor]);
```

**创建组件:** `CorrectShortcutsEditor.tsx` - 实现正确的智能快捷键逻辑

### 3. SSR问题修复 ✅
**问题:** `window is not defined` 错误

**解决方案:**
```typescript
const DynamicBlockNoteView = dynamic(
  () => import("@blocknote/mantine").then((mod) => mod.BlockNoteView),
  { 
    ssr: false,
    loading: () => <div>Loading editor...</div>
  }
);
```

## ❌ 仍需解决的核心问题

### 1. 真正的行内公式实现 🔴 HIGH PRIORITY

**当前状态:** 只有对话框模拟，没有真正的行内渲染

**需要实现:**
```typescript
// 行内公式的BlockNote规范
const inlineMathSpec = createReactInlineContentSpec({
  type: "inlineMath",
  propSchema: {
    latex: { default: "" }
  },
  content: "none"
}, {
  render: ({ inlineContent }) => (
    <InlineMathComponent latex={inlineContent.props.latex} />
  )
});
```

**技术挑战:**
- BlockNote 0.39.1 的行内内容API理解
- 与段落文本的混排渲染
- 点击编辑交互实现

### 2. 文本选择到公式转换 🔴 HIGH PRIORITY

**当前状态:** 只能检测选中文本，无法真正替换

**需要实现:**
- DOM操作和BlockNote API集成
- 选中文本范围的精确替换
- 支持撤销/重做操作

**技术难点:**
```typescript
// 需要实现的核心函数
function replaceSelectedTextWithInlineMath(editor, selectedText, latexFormula) {
  // 1. 获取精确的选择范围
  // 2. 创建行内公式对象
  // 3. 替换DOM中的选中内容
  // 4. 更新BlockNote的内部状态
}
```

### 3. $$formula$$ 自动检测 🟡 MEDIUM PRIORITY

**需要实现:**
- 输入时的实时文本解析
- 双美元符号的模式匹配
- 自动转换为行内公式

**技术方案:**
```typescript
// 文本输入监听和转换
const doubleDollarParser = {
  pattern: /\$\$([^$]+)\$\$/g,
  replace: (match, formula) => createInlineMath(formula)
};
```

### 4. 原生Slash命令集成 🟡 MEDIUM PRIORITY

**当前状态:** 无法真正集成到BlockNote的slash菜单

**需要研究:**
- BlockNote 0.39.1 的slash菜单扩展API
- 如何添加自定义命令到原生菜单
- `/math`, `/eq`, `/gs` 命令的实现

## 🔧 技术债务

### 类型安全问题
```typescript
// 当前使用临时方案
(editor as any).insertBlocks([...]);

// 需要改为
editor.insertBlocks([...], currentBlock, "after");
```

### 架构问题
- 多个编辑器组件重复代码
- 样式文件重复导入
- 缺少统一的数学功能模块

### 测试缺失
- 没有自动化测试
- 缺少不同场景的测试用例
- 无性能基准测试

## 📋 问题解决优先级

### 🔴 立即解决 (今天-明天)
1. **实现真正的行内公式渲染**
   - 创建InlineMathComponent
   - 集成到BlockNote schema
   - 基础显示和编辑功能

2. **完成文本转换功能**  
   - 选中文本 → 行内公式的实际替换
   - DOM操作和状态同步
   - 错误处理和边界情况

### 🟡 本周解决
1. $$formula$$ 自动检测转换
2. 原生slash命令研究和实现
3. 代码重构和类型安全改进

### 🟢 后续优化
1. 性能优化和内存管理
2. 更完整的键盘导航
3. 单元测试和集成测试

## 🎯 成功验证标准

### 用户体验验证
```
测试场景1: 文本转换
1. 输入 "E = mc^2" 并选中
2. 按 Ctrl+Shift+E  
3. ✅ 文本变为行内公式，可编辑

测试场景2: 自动检测  
1. 输入 "The formula $$x^2 + y^2 = z^2$$ is important"
2. ✅ $$...$$自动转换，其余文本不变

测试场景3: Slash命令
1. 输入 "/math"
2. ✅ 出现在slash菜单中，可选择创建公式块
```

### 技术质量验证
- [ ] 无TypeScript类型错误
- [ ] 无控制台错误或警告  
- [ ] 样式与原装BlockNote完全一致
- [ ] 性能表现良好，无明显卡顿
- [ ] 支持撤销/重做操作

---

**这份问题记录是我们前进的指南针，确保不再犯同样的错误！**